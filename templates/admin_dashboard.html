<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard | Mess Vote</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  {% include '_header.html' %}

  <div class="page-wrapper">
    <div class="choose-card" style="width: 950px;">
      <h1 class="main-heading">Admin Dashboard</h1>
      <h2 class="sub-heading">Meal Performance and Ratings Overview</h2>

      <!-- Weekly Trend -->
      <h3 style="margin-top:40px;">Weekly Rating Trend</h3>
      <canvas id="weeklyTrendChart" height="160"></canvas>

      {% if meal_averages %}
        <h3 style="color: var(--main-heading); margin-top: 25px;">
          Average Ratings by Meal
        </h3>
        <canvas id="mealChart" height="150"></canvas>
      {% endif %}

      {% if dish_averages %}
        <h3 style="color: var(--main-heading); margin-top: 35px;">
          Top Rated Dishes
        </h3>
        <canvas id="dishChart" height="170"></canvas>
      {% endif %}

      {% if star_meal %}
        <p style="margin-top: 25px; font-weight: bold; color: var(--sub-heading);">
          Star Dish of the Week:
          <span style="color: var(--main-heading);">{{ star_meal }}</span>
        </p>
      {% endif %}

      <div style="margin-top: 35px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
        <a href="{{ url_for('admin_menus') }}" class="btn">Back to Admin Menu</a>
        <a href="{{ url_for('admin_export') }}" class="btn">Export Ratings</a>
        <a href="{{ url_for('weekly_report') }}" class="btn">Weekly Report</a>
        <a href="{{ url_for('admin_aspect_summary') }}" class="btn">
          Aspect-wise Complaints
        </a>
      </div>
    </div>
  </div>

  <!-- Safe JSON Storage -->
  <script id="meal-data" type="application/json">
    {{ meal_averages | tojson }}
  </script>

  <script id="dish-data" type="application/json">
    {{ dish_averages | tojson }}
  </script>

  <script>
    const mealData = JSON.parse(document.getElementById('meal-data').textContent || '[]');
    const dishData = JSON.parse(document.getElementById('dish-data').textContent || '[]');

    const mealLabels = mealData.map(item => item[0]);
    const mealRatings = mealData.map(item => item[1]);
    const dishLabels = dishData.map(item => item[0]);
    const dishRatings = dishData.map(item => item[1]);

    const pastelColors = ["#F6C3A0", "#BD725D", "#FFD8B1", "#B4C5E4", "#F7B7A3", "#A2D2FF"];
    const chartTextColor = "#1f2937";
    const gridColor = "rgba(0,0,0,0.08)";

    const trendLabels = {{ trend_labels | tojson }};
    const trendValues = {{ trend_values | tojson }};

    if (trendLabels.length > 0) {
      new Chart(document.getElementById('weeklyTrendChart'), {
        type: 'line',
        data: {
          labels: trendLabels,
          datasets: [{
            label: 'Average Rating',
            data: trendValues,
            borderColor: '#2ecc71',
            backgroundColor: 'rgba(46, 204, 113, 0.2)',
            tension: 0.3,
            fill: true,
            pointRadius: 5
          }]
        },
        options: {
          responsive: true
        }
      });
    }

    if (mealLabels.length > 0) {
      new Chart(document.getElementById('mealChart'), {
        type: 'bar',
        data: {
          labels: mealLabels,
          datasets: [{
            data: mealRatings,
            backgroundColor: pastelColors,
            borderRadius: 10
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 5 }
          }
        }
      });
    }

    if (dishLabels.length > 0) {
      new Chart(document.getElementById('dishChart'), {
        type: 'bar',
        data: {
          labels: dishLabels.slice(0, 7),
          datasets: [{
            data: dishRatings.slice(0, 7),
            backgroundColor: pastelColors,
            borderRadius: 10
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 5 }
          }
        }
      });
    }
  </script>

  {% include '_footer.html' %}

</body>
</html>
