<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard | Mess Vote</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="login-page">
  {% include '_navbar.html' %}
  <div class="overlay">
    <div class="choose-card" style="width: 950px;">
      <h1 class="main-heading">Admin Dashboard</h1>
      <h2 class="sub-heading">Meal Performance and Ratings Overview</h2>

      {% if meal_averages %}
        <h3 style="color: var(--main-heading); margin-top: 25px;">
          Average Ratings by Meal
        </h3>
        <canvas id="mealChart" style="margin-top: 15px;"></canvas>
      {% endif %}

      {% if dish_averages %}
        <h3 style="color: var(--main-heading); margin-top: 35px;">
          Top Rated Dishes
        </h3>
        <canvas id="dishChart" style="margin-top: 15px;"></canvas>
      {% endif %}

      {% if star_meal %}
        <p style="margin-top: 25px; font-weight: bold; color: var(--sub-heading);">
          Star Dish of the Week:
          <span style="color: var(--main-heading);">{{ star_meal }}</span>
        </p>
      {% endif %}

      <div style="margin-top: 35px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
        <a href="{{ url_for('admin_menus') }}" class="btn">Back to Admin Menu</a>
        <a href="{{ url_for('admin_export') }}" class="btn">Export Ratings</a>
        <a href="{{ url_for('weekly_report') }}" class="btn">Weekly Report</a>
        <a href="{{ url_for('admin_aspect_summary') }}" class="btn">
          ðŸ“Š Aspect-wise Complaints
        </a>
      </div>

    </div>
  </div>

  <!-- Store Flask data in hidden JSON blocks to avoid parser errors -->
  <script id="meal-data" type="application/json">
    {{ meal_averages | tojson }}
  </script>

  <script id="dish-data" type="application/json">
    {{ dish_averages | tojson }}
  </script>

  <script>
    // Parse Flask data safely
    const mealData = JSON.parse(document.getElementById('meal-data').textContent || '[]');
    const dishData = JSON.parse(document.getElementById('dish-data').textContent || '[]');

    const mealLabels = mealData.map(item => item[0]);
    const mealRatings = mealData.map(item => item[1]);
    const dishLabels = dishData.map(item => item[0]);
    const dishRatings = dishData.map(item => item[1]);

    const pastelColors = ["#F6C3A0", "#BD725D", "#FFD8B1", "#B4C5E4", "#F7B7A3", "#A2D2FF"];

    // Chart 1: Average Ratings by Meal
    if (mealLabels.length > 0) {
      const ctx = document.getElementById('mealChart');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: mealLabels,
          datasets: [{
            label: 'Average Rating',
            data: mealRatings,
            backgroundColor: pastelColors,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { color: '#555', stepSize: 0.5 } },
            x: { ticks: { color: '#555' } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#FFF8F2',
              titleColor: '#333',
              bodyColor: '#555'
            }
          }
        }
      });
    }

    // Chart 2: Top Rated Dishes
    if (dishLabels.length > 0) {
      const ctx = document.getElementById('dishChart');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dishLabels.slice(0, 7),
          datasets: [{
            label: 'Average Rating',
            data: dishRatings.slice(0, 7),
            backgroundColor: pastelColors,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { color: '#555', stepSize: 0.5 } },
            x: { ticks: { color: '#555' } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#FFF8F2',
              titleColor: '#333',
              bodyColor: '#555'
            }
          }
        }
      });
    }
  </script>
</body>
</html>
